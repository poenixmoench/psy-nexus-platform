import axios from 'axios';

const OLLAMA_API = 'http://127.0.0.1:11434/api/generate';

export interface AgentConfig {
  name: string;
  model: string;
  systemPrompt: string;
  temperature?: number;
}

export const AGENT_CONFIGS: { [key: string]: AgentConfig } = {
  ORION: {
    name: 'ORION',
    model: 'ORION:latest',
    systemPrompt: 'Du bist ORION. Antworte pr√§gnant und strukturiert.',
    temperature: 0.7,
  },
  'FRONTEND-MEISTER': {
    name: 'FRONTEND-MEISTER',
    model: 'qwen2.5-coder:14b',
    systemPrompt: `üéØ Du bist FRONTEND-MEISTER - ABSOLUTE REGELN - KEINE AUSNAHMEN:
NUR WENN BENUTZER ETWAS VISUELLES VERLANGT:
1. ANTWORTE SOFORT MIT \`\`\`html BLOCK
2. NICHT: Um zu..., Ich werde..., Hier ist...
3. NICHT: Separate CSS/JS/HTML Snippets
4. NICHT: Erkl√§rungen oder Tutorials
5. NICHT: Externe Dateien

FORMAT EXAKT:
\`\`\`html
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projekt</title>
<style>/* ALLES CSS HIER */</style>
</head>
<body>
<!-- ALLES HTML HIER -->
<script>
// ALLES JS HIER - VANILLA JS NUR!
// CDN: https://cdn.jsdelivr.net/npm/chart.js
</script>
</body>
</html>
\`\`\`

ABSOLUT:
- Backticks √∂ffnen, HTML schreiben, Backticks zu
- KEIN Text davor/danach
- VANILLA JS - KEINE Frameworks`,
    temperature: 0.3,
  },
};

export class OllamaService {
  static async generateStream(
    userMessage: string,
    agentName: string,
    onChunk: (chunk: string) => void
  ): Promise<string> {
    const config = AGENT_CONFIGS[agentName] || AGENT_CONFIGS['ORION'];
    console.log(`ü§ñ [${config.name}] Processing: ${config.model}`);

    try {
      const response = await axios.post(
        OLLAMA_API,
        {
          model: config.model,
          prompt: userMessage,
          system: config.systemPrompt,
          stream: true,
          stop: ['```', 'Hier ist', 'Gerne', 'Erkl√§rung:', '---'],
          temperature: 0.05,
          top_p: 0.3,
          top_k: 10,
          num_predict: 500,
        },
        { responseType: 'stream' }
      );

      let fullText = '';

      return new Promise((resolve, reject) => {
        response.data.on('data', (chunk: Buffer) => {
          try {
            const lines = chunk.toString('utf8').split('\n');
            for (const line of lines) {
              if (line.trim()) {
                const json = JSON.parse(line);
                if (json.response) {
                  fullText += json.response;
                  onChunk(json.response);
                }
              }
            }
          } catch (err) {
            // Skip
          }
        });

        response.data.on('end', () => {
          console.log(`‚úÖ [${config.name}] Done`);
          resolve(fullText);
        });

        response.data.on('error', (err: any) => {
          reject(err);
        });
      });
    } catch (err: any) {
      console.error(`‚ùå Ollama Error:`, err.message);
      throw err;
    }
  }
}
